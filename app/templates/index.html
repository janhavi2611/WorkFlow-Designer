{% extends 'base.html' %}
{% block content %}
<div class="floating-shape" style="top:150px; left:30px;"></div>
  <div class="floating-shape" style="bottom:100px; right:50px;"></div>

<div class="mb-4 position-relative">
  <!-- Decorative floating circles -->
  <div style="position:absolute; width:100px; height:100px; background: rgba(255,255,255,0.1); border-radius:50%; top:-20px; left:-20px; z-index:0;"></div>
  <div style="position:absolute; width:150px; height:150px; background: rgba(255,255,255,0.08); border-radius:50%; bottom:-40px; right:-30px; z-index:0;"></div>

  <div class="card p-4 shadow-lg text-center" 
       style="background: linear-gradient(135deg, #654e3d, #d0b5a1); 
              border-radius: 25px; 
              box-shadow: 0 15px 30px rgba(0,0,0,0.2); 
              color: #fff;
              transform: translateY(-20px);
              animation: slideIn 1s forwards;">
    <h3 class="mb-2" style="color: #3a312a; font-weight:700;">
      Welcome, {% if request.user.is_authenticated %}{{ request.user.username }}{% else %}Guest{% endif %}!
    </h3>
    <p class="mb-0" style="color: #221d18; font-size:1.1rem;">
      Your productivity hub is here. Click the <i class="bi bi-plus-circle"></i> button to add your first task!
    </p>
  </div>
</div>

<style>
@keyframes slideIn {
  0% { transform: translateY(-50px); opacity: 0; }
  100% { transform: translateY(0); opacity: 1; }
}
</style>



<div class="row">
  <!-- Left: Add New Todo -->
<!-- Left: Add New Todo (Initially Hidden) -->
<div class="col-lg-4 mb-4" id="addTodoPanel" style="display:none;">
  <div class="card p-3 shadow-sm card-add-todo">
    <h5 class="mb-3 text-center" style="color: #4a2c1a;">
      <i class="bi bi-plus-circle mr-2"></i>Add New Task
    </h5>

    <form method="POST" action="{% url 'add_todo' %}">
      {% csrf_token %}
      <div class="d-flex flex-column gap-2">

        {% for field in form %}
        <div class="form-group mb-1">
          {{ field }}
          {% if field.errors %}
          <div class="text-danger small">{{ field.errors }}</div>
          {% endif %}
        </div>
        {% endfor %}

        <button type="submit" class="btn btn-block btn-brown mt-2">
          <i class="bi bi-plus-circle mr-1"></i>Add
        </button>
      </div>
    </form>

    {% if form.non_field_errors %}
    <div class="alert alert-danger mt-2">{{ form.non_field_errors }}</div>
    {% endif %}
  </div>
</div>




  <!-- Right: Task List -->
  <div class="col-lg-8">
    
    <!-- Filter Form -->
    <!-- The form submits to the current URL, which is the 'home' view -->
    <form method="GET" action="{% url 'home' %}" id="filter-form" class="d-flex mb-3 justify-content-between align-items-center flex-wrap gap-2">
      
      <!-- Search Input -->
      <!-- The 'name' attribute must match the parameter in views.py (q) -->
      <input 
        type="text" 
        name="q" 
        class="form-control" 
        style="max-width: 250px; flex-grow: 1;"
        placeholder="Search tasks..." 
        value="{{ q|default_if_none:'' }}"
      >
      
      <div class="d-flex gap-2 flex-grow-1 justify-content-end">
        
        <!-- Category Filter -->
        <select name="category" class="form-control" onchange="document.getElementById('filter-form').submit()">
          <option value="">All Categories</option>
          {% for choice in form.category.field.choices %}
            <option 
              value="{{ choice.0 }}" 
              {% if choice.0 == category_filter %}selected{% endif %}>
              {{ choice.1 }}
            </option>
          {% endfor %}
        </select>
        
        <!-- Status Filter -->
        <select name="status" class="form-control" onchange="document.getElementById('filter-form').submit()">
          <option value="">All Status</option>
          {% for choice in form.status.field.choices %}
            <option 
              value="{{ choice.0 }}" 
              {% if choice.0 == status_filter %}selected{% endif %}>
              {{ choice.1 }}
            </option>
          {% endfor %}
        </select>
        
        <!-- Priority Filter -->
        <select name="priority" class="form-control" onchange="document.getElementById('filter-form').submit()">
          <option value="">All Priority</option>
          {% for choice in form.priority.field.choices %}
            <option 
              value="{{ choice.0 }}" 
              {% if choice.0|slugify == priority_filter|slugify %}selected{% endif %}>
              {{ choice.1 }}
            </option>
          {% endfor %}
        </select>
      </div>
      
      <!-- Hidden field for sorting order - ensures it persists during filtering -->
      <input type="hidden" name="order" value="{{ order_by }}">
      
      <!-- A hidden submit button allows search to work on Enter key -->
      <button type="submit" class="btn btn-primary d-none">Filter</button>
    </form>
    <!-- End Filter Form -->
    

    <!-- Task List -->
    {% for todo in todos %}
    <div class="todo-card {% if todo.status == 'C' %}completed{% endif %}">
      <div class="todo-actions">
        <!-- Change Status Button -->
        {% if todo.status == 'P' %}
          <a href="{% url 'change_todo' todo.id 'C' %}"><button title="Mark Done"><i class="bi bi-check2-circle"></i></button></a>
        {% else %}
          <a href="{% url 'change_todo' todo.id 'P' %}"><button title="Mark Pending"><i class="bi bi-arrow-counterclockwise"></i></button></a>
        {% endif %}
        
        <a href="{% url 'edit_todo' todo.id %}"><button title="Edit"><i class="bi bi-pencil"></i></button></a>
        <a href="{% url 'delete_todo' todo.id %}"><button title="Delete"><i class="bi bi-trash"></i></button></a>
      </div>

      <div class="todo-title">{{ todo.title }}</div>
      {% if todo.description %}
      <div class="todo-desc">{{ todo.description }}</div>
      {% endif %}

      <div class="mt-2">
        {% if todo.status == 'P' %}
        <span class="badge-status badge-pending">Pending</span>
        {% elif todo.status == 'C' %}
        <span class="badge-status badge-completed">Completed</span>
        {% endif %}
        <span class="todo-date">Due: {{ todo.due_date|date:"M d, Y" }}</span>
        <!-- Display Priority and Category here for clarity -->
        <span class="badge-tag">{{ todo.category }}</span>
        <span class="badge-tag badge-{{ todo.get_priority_display|lower }}">{{ todo.get_priority_display }}</span>
      </div>
    </div>
    {% empty %}
    <p class="text-muted">No tasks yet. Add your first Todo!</p>
    {% endfor %}
  </div>
</div>

<!-- Progress Section -->
<div class="mt-4">
  <h6 class="mb-2"><i class="bi bi-graph-up-arrow"></i> Task Progress ({{ progress }}%)</h6>
  <div class="progress-container">
    <div class="progress-bar" id="progressBar" style="width: {{ progress }}%;"></div>
  </div>
</div>

<script>
  // Script to handle search input interaction (submits form on enter)
  document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.querySelector('input[name="q"]');
      if (searchInput) {
          // If the user types in the search box and presses Enter, submit the form.
          searchInput.addEventListener('keypress', function(e) {
              if (e.key === 'Enter') {
                  e.preventDefault(); // Prevent default form submission via enter key
                  document.getElementById('filter-form').submit();
              }
          });
      }
  });
  
  // No need for the progress calculation script, as it's passed from the view now.
  // The progress bar style is now set via Django template tag: style="width: {{ progress }}%;"
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const addBtn = document.getElementById('toggleAddTodo');
  const addPanel = document.getElementById('addTodoPanel');

  addBtn.addEventListener('click', function(e) {
    e.preventDefault();
    if(addPanel.style.display === "none") {
      addPanel.style.display = "block";
      addPanel.scrollIntoView({behavior: "smooth", block: "start"});
    } else {
      addPanel.style.display = "none";
    }
  });
});
</script>


<!-- Floating Add Button -->
<!-- Assuming 'add_todo' is the correct URL name -->
<!-- Floating Add Button -->
<a href="#" id="toggleAddTodo" class="floating-btn" title="Add New Task">
  <i class="bi bi-plus-lg"></i>
</a>


{% endblock %}
